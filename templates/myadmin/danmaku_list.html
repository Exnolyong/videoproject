{% extends 'myadmin/base.html' %}
{% load static %}
{% load video_tag %}

{% block content %}
    <div class="ui container">
        <div class="ui segment">
            <div class="ui grid">
                <div class="row">
                    <div class="column">
                        <h3>弹幕管理</h3>
                        <div class="ui divider"></div>
                        <div class="ui form">
                            <div class="field">
                                <div class="ui action input">
                                    <input type="text" placeholder="搜索弹幕内容..." id="search_input">
                                    <button class="ui button" id="search_button">搜索</button>
                                </div>
                            </div>
                        </div>
                        <table class="ui table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户</th>
                                    <th>视频</th>
                                    <th>内容</th>
                                    <th>时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for danmaku in danmaku_list %}
                                    <tr>
                                        <td>{{ danmaku.id }}</td>
                                        <td>{{ danmaku.user.nickname }}</td>
                                        <td>{{ danmaku.video.title }}</td>
                                        <td>{{ danmaku.content }}</td>
                                        <td>{{ danmaku.timestamp|time_since }}</td>
                                        <td>
                                            <button class="ui red button delete-danmaku" data-id="{{ danmaku.id }}">删除</button>
                                        </td>
                                    </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="center aligned">暂无弹幕</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if is_paginated %}
                            <div class="ui pagination menu">
                                {% if page_obj.has_previous %}
                                    <a class="item" href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">上一页</a>
                                {% else %}
                                    <a class="item disabled">上一页</a>
                                {% endif %}
                                {% for page in page_list %}
                                    {% if page == page_obj.number %}
                                        <a class="item active" href="?page={{ page }}{% if q %}&q={{ q }}{% endif %}">{{ page }}</a>
                                    {% else %}
                                        <a class="item" href="?page={{ page }}{% if q %}&q={{ q }}{% endif %}">{{ page }}</a>
                                    {% endif %}
                                {% endfor %}
                                {% if page_obj.has_next %}
                                    <a class="item" href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}">下一页</a>
                                {% else %}
                                    <a class="item disabled">下一页</a>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        $(function () {
            // 删除弹幕
            $('.delete-danmaku').click(function () {
                var id = $(this).data('id')
                if (confirm('确定要删除这条弹幕吗？')) {
                    $.ajax({
                        type: 'POST',
                        url: '{% url "myadmin:danmaku_delete" %}',
                        data: {
                            'id': id
                        },
                        dataType: 'json',
                        success: function (data) {
                            if (data.code == 0) {
                                window.location.reload()
                            } else {
                                alert(data.msg)
                            }
                        },
                        error: function (xhr, type) {
                            alert('删除失败')
                        }
                    })
                }
            })

            // 搜索弹幕
            $('#search_button').click(function () {
                var q = $('#search_input').val()
                window.location.href = '{% url "myadmin:danmaku_list" %}?q=' + q
            })

            // 回车搜索
            $('#search_input').keypress(function (e) {
                if (e.which == 13) {
                    $('#search_button').click()
                }
            })
        })
    </script>

{% block title %}弹幕管理{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            弹幕管理
            <small>管理所有弹幕</small>
        </h1>
        <ol class="breadcrumb">
            <li><a href="{% url 'myadmin:index' %}"><i class="fa fa-dashboard"></i> 首页</a></li>
            <li class="active">弹幕管理</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">弹幕列表</h3>
                        <div class="box-tools">
                            <div class="input-group input-group-sm" style="width: 150px;">
                                <input type="text" name="table_search" class="form-control pull-right" placeholder="搜索内容" value="{{ q }}">
                                <div class="input-group-btn">
                                    <button type="submit" class="btn btn-default"><i class="fa fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-hover">
                            <tbody>
                            <tr>
                                <th>ID</th>
                                <th>用户</th>
                                <th>视频</th>
                                <th>内容</th>
                                <th>时间点</th>
                                <th>位置</th>
                                <th>颜色</th>
                                <th>发送时间</th>
                                <th>操作</th>
                            </tr>
                            {% for danmaku in danmaku_list %}
                            <tr>
                                <td>{{ danmaku.id }}</td>
                                <td>{{ danmaku.user.username }}</td>
                                <td><a href="{% url 'video:detail' danmaku.video.id %}" target="_blank">{{ danmaku.video.title }}</a></td>
                                <td>{{ danmaku.content }}</td>
                                <td>{{ danmaku.video_time }}秒</td>
                                <td>
                                    {% if danmaku.position == 'top' %}顶部
                                    {% elif danmaku.position == 'bottom' %}底部
                                    {% else %}滚动
                                    {% endif %}
                                </td>
                                <td style="color: {{ danmaku.color }};">{{ danmaku.color }}</td>
                                <td>{{ danmaku.timestamp|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    <button class="btn btn-danger btn-xs delete-btn" data-id="{{ danmaku.id }}">删除</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center">暂无弹幕</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- /.box-body -->
                    <!-- 分页 -->
                    <div class="box-footer clearfix">
                        <ul class="pagination pagination-sm no-margin pull-right">
                            {% if page_obj.has_previous %}
                            <li><a href="?page={{ page_obj.previous_page_number }}{% if q %}&q={{ q }}{% endif %}">&laquo;</a></li>
                            {% else %}
                            <li class="disabled"><a href="#">&laquo;</a></li>
                            {% endif %}
                            {% for page in page_list %}
                            {% if page == page_obj.number %}
                            <li class="active"><a href="?page={{ page }}{% if q %}&q={{ q }}{% endif %}">{{ page }}</a></li>
                            {% else %}
                            <li><a href="?page={{ page }}{% if q %}&q={{ q }}{% endif %}">{{ page }}</a></li>
                            {% endif %}
                            {% endfor %}
                            {% if page_obj.has_next %}
                            <li><a href="?page={{ page_obj.next_page_number }}{% if q %}&q={{ q }}{% endif %}">&raquo;</a></li>
                            {% else %}
                            <li class="disabled"><a href="#">&raquo;</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <!-- /.box -->
            </div>
        </div>
    </section>
    <!-- /.content -->
</div>
{% endblock %}

{% block script %}
<script>
    $(function () {
        // 删除弹幕
        $('.delete-btn').click(function () {
            var danmakuId = $(this).data('id');
            var row = $(this).closest('tr');
            if (confirm('确定要删除这条弹幕吗？')) {
                $.ajax({
                    url: '{% url "myadmin:danmaku_delete" %}',
                    type: 'POST',
                    data: { 'danmaku_id': danmakuId },
                    success: function (response) {
                        if (response.code === 0) {
                            row.remove();
                            alert('删除成功');
                        } else {
                            alert('删除失败：' + response.msg);
                        }
                    },
                    error: function () {
                        alert('删除失败，请稍后重试');
                    }
                });
            }
        });

        // 搜索功能
        $('input[name="table_search"]').keypress(function (e) {
            if (e.which === 13) {
                var searchTerm = $(this).val();
                window.location.href = '{% url "myadmin:danmaku_list" %}?q=' + encodeURIComponent(searchTerm);
            }
        });
    });
</script>

{% endblock %}
